image: "debian:latest"
stages:
  - build
patch_and_build_signal:
  stage: build
  script:
    - "apt update && apt install -y git"
    - "apt install -y default-jdk"
    - "apt install -y lib32stdc++6 unzip wget"
    - "wget https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip" # download android sdk
    - "echo '444e22ce8ca0f67353bda4b85175ed3731cae3ffa695ca18119cbacef1c1bea0  sdk-tools-linux-3859397.zip' |sha256sum -c"
    - "unzip sdk-tools-linux-3859397.zip -d /sdk-tools-linux" # unzip android sdk
    - "yes | /sdk-tools-linux/tools/bin/sdkmanager --licenses || true" # to accept licenses
    - "export JAVA_OPTS=\"-Xmx3096M\""
    - "export GRADLE_OPTS=\"-Dorg.gradle.jvmargs=-Xmx4608M\""
    - "export ANDROID_HOME=\"/sdk-tools-linux\"" # set ANDROID_HOME env var
    - "git clone https://github.com/WhisperSystems/Signal-Android.git && cd Signal-Android && git checkout v4.19.3" # get signal sources
    - "./gradlew clean" # cleanup
    #- "rm $CI_PROJECT_DIR/Signal-Android/test/unitTest/java/org/thoughtcrime/securesms/jobs/AttachmentDownloadJobTest.java -f" # because of https://github.com/signalapp/Signal-Android/issues/7458
    #- "rm $CI_PROJECT_DIR/Signal-Android/test/unitTest/java/org/thoughtcrime/securesms/crypto/MasterCipherTest.java -f" # because of https://github.com/signalapp/Signal-Android/issues/7458
    - "git apply $CI_PROJECT_DIR/destroy-gcm-support.patch" # apply our patch
    - "./gradlew assembleWebsiteRelease assembleWebsiteDebug"
    # assembleRelease assembleDebug"
    - "mkdir -p $CI_PROJECT_DIR/artifacts"
    - "find $CI_PROJECT_DIR/Signal-Android/build/outputs -name *.apk"
    - "mv $(find $CI_PROJECT_DIR/Signal-Android/build/outputs -name *.apk) $CI_PROJECT_DIR/artifacts"
    - "ls -lh $CI_PROJECT_DIR/artifacts"
  artifacts:
    paths:
      - "$CI_PROJECT_DIR/artifacts/*.apk"
  only:
    - master
    
    
    
    